<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/appstyle.css">
    {% for bek in seb['beks'] %}
    <meta name="seb-bek" content="{{ bek }}">
    {% endfor %}
    <meta name="seb-ck" content="{{ seb['ck'] }}">
    <meta name="seb-ua" content="{{ seb['ua'] }}">
    <script src="/static/sebLock.js"></script>
</head>

<body class="danger-active">
    <header id="mainHeader" class="top-header">
        <div id="header-content" class="d-flex align-items-center justify-content-between">
            <div id="seb-check" class="alert alert-danger bad">JavaScript is required to view this content.</div>
            <div id="exam-key">
                {{ exam_key }}{% if app_name %} - {{ app_name }}{% endif %}
            </div>
            <div>
                <div class="help-icon">?</div>
                <div class="help-tooltip">
                    <h3>ðŸ“– Instructions</h3>
                    <ul>
                        <li>This tool is secured by Safe Exam Browser.</li>
                        <li><strong>Reset View:</strong> Click the "Reset View" button to reload the content.</li>
                    </ul>
                    <p style="margin-top: 10px; font-style: italic; color: #666;">
                        ðŸ”’ Use of Safe Exam Browser is required.
                    </p>
                    <div id="security-information">
                        <ul>
                            <li id="seb-ck">SEB Not Detected</li>
                            <li id="seb-bek">SEB Not Detected</li>
                            <li id="seb-ua">SEB Not Detected</li>
                            <li id="seb-version">SEB Not Detected</li>
                        </ul>
                    </div>
                    <div id="copyright-info">
                        Â© Caleb Li 2025. No Rights Reserved.
                    </div>
                </div>
            </div>
            <button id="reset-view" class="btn btn-sm btn-secondary">Reset View</button>
        </div>
    </header>
    <main id="mainContent" style="position:absolute; top:0; left:0; right:0; bottom:30px; width:100vw;">
        <iframe id="mainIframe" src="{{ iframe_url }}" sandbox="allow-scripts allow-forms"
            style="width:100%; height:100%; border:none;"></iframe>
    </main>
    <script>
        const header = document.getElementById('mainHeader');
        const mainContent = document.getElementById('mainContent');
        const mainIframe = document.getElementById('mainIframe');

        function getHeaderHeight() {
            return header.offsetHeight;
        }

        function resizeMainArea() {
            const headerHeight = getHeaderHeight();
            mainContent.style.top = headerHeight + 'px';
            mainIframe.style.height = '100%';
        }
        window.addEventListener('resize', resizeMainArea);
        // Initial sizing
        resizeMainArea();
        // Reset View button functionality
        document.getElementById('reset-view').addEventListener('click', () => {
            mainIframe.src = mainIframe.src;
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const examId = '{{ exam_id }}';
        const appName = '{{ app_name }}';
        let socket;
        let teacherMessageModal;
        
        // Initialize WebSocket
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            setupFocusTracking();
            createMessageModal();
        });
        
        function initializeWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                
                // Join exam as student
                socket.emit('join_exam_student', {
                    exam_id: examId,
                    window_type: 'app',
                    tool_name: '{{ app_name }}',
                    user_info: {
                        email: '{{ session.get("email", "anonymous@exam.local") }}',
                        name: '{{ session.get("name", "Anonymous User") }}',
                        google_id: '{{ session.get("google_id", "anonymous") }}'
                    }
                });
                
                // Start heartbeat
                startHeartbeat();
            });
            
            socket.on('teacher_message', function(data) {
                showTeacherMessage(data.title, data.message);
            });
            
            socket.on('redirect_to_quit', function(data) {
                window.location.href = data.url;
            });
            
            socket.on('pong', function(data) {
                // Server acknowledged ping
            });
        }
        
        function startHeartbeat() {
            setInterval(() => {
                if (socket && socket.connected) {
                    socket.emit('student_ping', { exam_id: examId });
                }
            }, 5000); // Ping every 5 seconds
        }
        
        function setupKeypressTracking() {
            let lastKeypressTime = 0;
            const throttleMs = 2000; // Only send keypress events every 2 seconds
            
            document.addEventListener('keydown', function(event) {
                const now = Date.now();
                if (now - lastKeypressTime >= throttleMs && socket && socket.connected) {
                    socket.emit('student_keypress', { exam_id: examId });
                    lastKeypressTime = now;
                }
            });
        }
        
        function setupFocusTracking() {
            window.addEventListener('focus', function() {
                if (socket && socket.connected) {
                    socket.emit('student_focus_update', {
                        exam_id: examId,
                        window_type: 'app',
                        tool_name: '{{ app_name }}',
                        is_focused: true
                    });
                }
            });
            
            window.addEventListener('blur', function() {
                if (socket && socket.connected) {
                    socket.emit('student_focus_update', {
                        exam_id: examId,
                        window_type: 'app',
                        tool_name: '{{ app_name }}',
                        is_focused: false
                    });
                }
            });
        }
        
        function createMessageModal() {
            const modalHTML = `
                <div class="modal fade" id="teacherMessageModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="teacherMessageTitle">Message from Teacher</h5>
                            </div>
                            <div class="modal-body" id="teacherMessageBody">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            teacherMessageModal = new bootstrap.Modal(document.getElementById('teacherMessageModal'));
        }
        
        function showTeacherMessage(title, message) {
            document.getElementById('teacherMessageTitle').textContent = title;
            document.getElementById('teacherMessageBody').innerHTML = message.replace(/\n/g, '<br>');
            teacherMessageModal.show();
        }
        
        // Start keypress tracking
        setupKeypressTracking();
    </script>
</body>

</html>
